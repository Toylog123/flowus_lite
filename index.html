<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlowUs Lite Pro - ä¿®å¤ç‰ˆ</title>
    <style>
        /* ========================================================
           1. CSS æ ·å¼é‡ç½®ä¸æ ¸å¿ƒå˜é‡
           ======================================================== */
        :root {
            /* æµ…è‰²æ¨¡å¼å˜é‡ */
            --bg-primary: #ffffff;
            --bg-secondary: #f7f9fb;
            --bg-tertiary: #f0f2f5;
            --bg-hover: #f5f5f5;
            --bg-active: #eef0f3;
            
            --text-primary: #37352f;
            --text-secondary: #787774;
            --text-tertiary: #aeb5bc;
            
            --accent-blue: #4285f4;
            --accent-green: #34a853;
            --accent-yellow: #fbbc04;
            --accent-red: #ea4335;
            --accent-purple: #9c27b0;
            
            --border-light: #e6e6e6;
            
            --sidebar-width: 260px;
            --topbar-height: 48px;
            --content-width: 900px;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
        }

        [data-theme="dark"] {
            /* æ·±è‰²æ¨¡å¼å˜é‡ */
            --bg-primary: #191919;
            --bg-secondary: #252525;
            --bg-tertiary: #2e2e2e;
            --bg-hover: #333333;
            --bg-active: #3a3a3a;
            --text-primary: #e6e6e6;
            --text-secondary: #a6a6a6;
            --text-tertiary: #666666;
            --border-light: #404040;
        }

        /* åŸºç¡€é‡ç½® */
        * { box-sizing: border-box; outline: none; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: var(--font-family); background: var(--bg-primary); color: var(--text-primary); overflow: hidden; }
        
        /* å…³é”®ä¿®å¤ï¼šSVG å°ºå¯¸é™åˆ¶ï¼Œé˜²æ­¢å›¾æ ‡å·¨å¤§åŒ– */
        svg { width: 18px; height: 18px; fill: currentColor; display: block; }
        .icon-small { width: 14px; height: 14px; }

        /* ========================================================
           2. å¸ƒå±€ç³»ç»Ÿ (Sidebar + Main)
           ======================================================== */
        #app { display: flex; height: 100vh; width: 100vw; }

        .sidebar {
            width: var(--sidebar-width);
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-light);
            display: flex; flex-direction: column;
            flex-shrink: 0;
            transition: background 0.3s;
        }

        .sidebar-header {
            height: var(--topbar-height);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 16px; font-weight: 600;
        }
        .logo-area { display: flex; align-items: center; gap: 8px; font-size: 14px; }
        .logo-icon { 
            background: var(--accent-blue); color: white; width: 20px; height: 20px; 
            border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 12px; 
        }

        .sidebar-list { flex: 1; overflow-y: auto; padding: 8px; }
        .sidebar-item {
            padding: 6px 10px; margin-bottom: 2px; border-radius: 4px; cursor: pointer;
            display: flex; align-items: center; gap: 8px; font-size: 14px; color: var(--text-primary);
        }
        .sidebar-item:hover { background: var(--bg-hover); }
        .sidebar-item.active { background: var(--bg-active); font-weight: 500; }
        
        .sidebar-section-title {
            padding: 16px 16px 4px; font-size: 11px; color: var(--text-secondary); 
            font-weight: 700; text-transform: uppercase;
        }
        /* ç›®å½•ç¼©è¿› */
        .toc-list .sidebar-item { font-size: 13px; color: var(--text-secondary); }
        .toc-list .sidebar-item.h1 { padding-left: 10px; font-weight: 600; }
        .toc-list .sidebar-item.h2 { padding-left: 24px; }

        .sidebar-footer { padding: 8px; border-top: 1px solid var(--border-light); }

        /* ä¸»å†…å®¹åŒº */
        #main { flex: 1; display: flex; flex-direction: column; min-width: 0; }
        
        .top-bar {
            height: var(--topbar-height);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 24px; background: var(--bg-primary);
            border-bottom: 1px solid transparent;
        }
        .breadcrumbs { font-size: 14px; display: flex; align-items: center; gap: 6px; }
        .top-actions { display: flex; align-items: center; gap: 12px; }
        
        .icon-btn {
            background: transparent; border: none; padding: 4px; border-radius: 4px;
            color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .icon-btn:hover { background: var(--bg-hover); color: var(--text-primary); }

        .editor-scroller { flex: 1; overflow-y: auto; }
        .editor-container { max-width: var(--content-width); margin: 0 auto; padding: 48px 60px 100px; }
        
        .page-title-input {
            width: 100%; border: none; background: transparent;
            font-size: 36px; font-weight: 700; color: var(--text-primary);
            margin-bottom: 24px;
        }

        .bottom-stats-bar {
            height: 32px; background: var(--bg-primary); border-top: 1px solid var(--border-light);
            display: flex; align-items: center; justify-content: flex-end; padding: 0 20px;
            font-size: 12px; color: var(--text-secondary); gap: 8px;
        }

        /* ========================================================
           3. å—ä¸ç¼–è¾‘å™¨ç»„ä»¶
           ======================================================== */
        .blocks-container { display: flex; flex-direction: column; }
        
        .content-block {
            position: relative; margin: 4px 0; padding: 2px 0; display: flex; align-items: flex-start;
        }
        .content-block:hover .block-handle-area { opacity: 1; }
        
        .block-handle-area {
            position: absolute; left: -36px; top: 3px; width: 24px; height: 24px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 4px; cursor: grab; color: var(--text-tertiary); opacity: 0; transition: opacity 0.2s;
        }
        .block-handle-area:hover { background: var(--bg-hover); color: var(--text-primary); }

        .block-content { flex: 1; min-height: 24px; font-size: 16px; line-height: 1.6; word-break: break-word; outline: none; }
        .block-content:empty::before { content: attr(data-placeholder); color: var(--text-tertiary); pointer-events: none; }
        
        /* æ ‡é¢˜æ ·å¼ */
        [data-type="h1"] .block-content { font-size: 30px; font-weight: 700; margin-top: 16px; }
        [data-type="h2"] .block-content { font-size: 24px; font-weight: 600; margin-top: 12px; }
        
        /* å¾…åŠ */
        .checkbox-wrapper { width: 20px; height: 24px; margin-right: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .checkbox { width: 16px; height: 16px; border: 1px solid var(--text-secondary); border-radius: 3px; }
        .content-block.checked .checkbox { background: var(--accent-blue); border-color: var(--accent-blue); }
        .content-block.checked .block-content { text-decoration: line-through; color: var(--text-tertiary); }

        /* ========================================================
           4. é«˜çº§æ—¶é—´è½´ (Timeline V2)
           ======================================================== */
        .timeline-v2-container { width: 100%; margin: 12px 0; font-size: 14px; user-select: none; }
        
        .block-toolbar {
            display: flex; align-items: center; gap: 8px; padding: 4px 8px;
            background: var(--bg-secondary); border: 1px solid var(--border-light);
            border-bottom: none; border-radius: 6px 6px 0 0; margin-top: 4px; font-size: 12px;
        }
        .toolbar-btn {
            padding: 2px 8px; border: 1px solid var(--border-light); background: var(--bg-primary);
            border-radius: 4px; cursor: pointer; font-size: 12px; color: var(--text-primary);
        }
        .toolbar-btn:hover { background: var(--bg-hover); }

        /* å¹´ä»½åˆ†ç»„ */
        .tl-year-group { margin-bottom: 24px; border: 1px solid var(--border-light); border-top: none; padding: 16px; border-radius: 0 0 6px 6px; }
        /* ä¿®å¤ï¼šå¦‚æœæ˜¯ç¬¬ä¸€ä¸ªå…ƒç´ ï¼ŒåŠ ä¸Šé¡¶éƒ¨è¾¹æ¡† */
        .timeline-v2-container .tl-year-group:first-of-type { border-top: 1px solid var(--border-light); border-radius: 6px; }
        
        .tl-year-header {
            display: flex; align-items: center; gap: 8px; font-size: 18px; font-weight: 700; 
            color: var(--text-primary); padding: 8px 0; cursor: pointer;
        }
        .tl-toggle-icon { width: 20px; height: 20px; color: var(--text-tertiary); transition: transform 0.2s; }
        .tl-group-collapsed .tl-toggle-icon { transform: rotate(-90deg); }
        .tl-group-collapsed .tl-month-list { display: none; }

        /* æœˆä»½åˆ†ç»„ */
        .tl-month-list { margin-left: 12px; border-left: 2px solid var(--border-light); padding-left: 16px; }
        .tl-month-group { margin-bottom: 20px; }
        .tl-month-header {
            display: flex; align-items: center; justify-content: space-between;
            font-size: 15px; font-weight: 600; color: var(--text-primary); padding: 6px 0 12px 0;
        }
        .tl-month-badge {
            background: var(--bg-secondary); color: var(--text-secondary); padding: 2px 8px; 
            border-radius: 12px; font-size: 11px; font-weight: normal;
        }

        /* æ—¥æœŸè¡Œ (Grid) */
        .tl-day-row { display: grid; grid-template-columns: 80px 1fr; gap: 16px; margin-bottom: 12px; }
        .tl-day-label { text-align: right; padding-top: 10px; color: var(--text-secondary); }
        .tl-day-num { font-size: 16px; font-weight: 600; color: var(--text-primary); }
        .tl-day-week { font-size: 12px; color: var(--text-tertiary); }
        .tl-event-list { display: flex; flex-direction: column; gap: 8px; padding-bottom: 8px; }

        /* äº‹ä»¶å¡ç‰‡ */
        .event-card {
            background: var(--bg-primary); border: 1px solid var(--border-light);
            border-left-width: 4px; border-radius: 6px; padding: 10px 12px;
            transition: all 0.2s ease; position: relative;
        }
        .event-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); transform: translateY(-1px); z-index: 10; }

        .type-task { border-left-color: var(--accent-blue); }
        .type-meeting { border-left-color: var(--accent-green); }
        .type-milestone { border-left-color: var(--accent-yellow); }
        
        .ec-header { display: flex; align-items: flex-start; gap: 8px; margin-bottom: 6px; }
        .ec-icon { flex-shrink: 0; font-size: 14px; margin-top: 2px; font-weight: bold; }
        .ec-title { flex: 1; font-size: 14px; font-weight: 500; line-height: 1.4; outline: none; }
        
        .ec-props { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
        .ec-tag {
            display: inline-flex; align-items: center; padding: 2px 6px; border-radius: 4px;
            font-size: 11px; background: var(--bg-secondary); color: var(--text-secondary);
        }
        .ec-tag.status-doing { background: rgba(66, 133, 244, 0.1); color: var(--accent-blue); }
        .ec-tag.status-done { background: rgba(52, 168, 83, 0.1); color: var(--accent-green); }
        .ec-tag.priority-high { color: var(--accent-red); background: rgba(234, 67, 53, 0.1); }
        
        .ec-meta {
            display: flex; align-items: center; gap: 12px; margin-top: 8px; padding-top: 8px;
            border-top: 1px solid var(--bg-secondary); font-size: 11px; color: var(--text-tertiary);
        }
        .ec-meta-item { display: flex; align-items: center; gap: 4px; }
        
        .tl-add-btn {
            opacity: 0; margin-top: 4px; font-size: 12px; color: var(--text-tertiary); 
            cursor: pointer; display: flex; align-items: center; gap: 4px; padding: 4px; transition: opacity 0.2s;
        }
        .tl-add-btn:hover { color: var(--accent-blue); }
        .tl-day-row:hover .tl-add-btn { opacity: 1; }

        /* ========================================================
           5. å¼¹çª—èœå•
           ======================================================== */
        .popup-menu {
            position: fixed; z-index: 2000; background: var(--bg-primary); 
            border: 1px solid var(--border-light); box-shadow: 0 4px 16px rgba(0,0,0,0.15); 
            border-radius: 6px; width: 200px; padding: 6px 0;
            max-height: 300px; overflow-y: auto;
        }
        .menu-header { font-size: 11px; color: var(--text-secondary); padding: 6px 12px; font-weight: 700; }
        .menu-item { display: flex; align-items: center; gap: 10px; padding: 6px 12px; font-size: 14px; cursor: pointer; color: var(--text-primary); }
        .menu-item:hover { background: var(--bg-hover); }
        .menu-icon { width: 22px; height: 22px; border: 1px solid var(--border-light); border-radius: 4px; display: flex; align-items: center; justify-content: center; }
        .editor-bottom-trigger { height: 100px; cursor: text; }
    </style>
</head>
<body>

    <svg style="display: none;">
        <symbol id="icon-page" viewBox="0 0 24 24"><path fill="currentColor" d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></symbol>
        <symbol id="icon-plus" viewBox="0 0 24 24"><path fill="currentColor" d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></symbol>
        <symbol id="icon-trash" viewBox="0 0 24 24"><path fill="currentColor" d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></symbol>
        <symbol id="icon-moon" viewBox="0 0 24 24"><path fill="currentColor" d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-2.98 0-5.4-2.42-5.4-5.4 0-1.81.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z"/></symbol>
        <symbol id="icon-drag" viewBox="0 0 24 24"><path fill="currentColor" d="M11 18c0 1.1-.9 2-2 2s-2-.9-2-2 .9-2 2-2 2 .9 2 2zm-2-8c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0-6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm6 4c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></symbol>
        <symbol id="icon-chevron-down" viewBox="0 0 24 24"><path fill="currentColor" d="M16.59 8.59L12 13.17 7.41 8.59 6 10l6 6 6-6z"/></symbol>
        <symbol id="icon-clock" viewBox="0 0 24 24"><path fill="currentColor" d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></symbol>
        <symbol id="icon-user" viewBox="0 0 24 24"><path fill="currentColor" d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></symbol>
        <symbol id="icon-table" viewBox="0 0 24 24"><path fill="currentColor" d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM5 19V5h14v14H5zm2-2h10v-2H7v2zm0-4h10v-2H7v2zm0-4h10V7H7v2z"/></symbol>
        <symbol id="icon-timeline" viewBox="0 0 24 24"><path fill="currentColor" d="M23 8c0 1.1-.9 2-2 2-.18 0-.35-.02-.51-.07l-3.56 3.55c.05.16.07.33.07.52 0 1.1-.9 2-2 2s-2-.9-2-2c0-.19.02-.36.07-.52l-2.55-2.55c-.16.05-.33.07-.52.07s-.36-.02-.52-.07l-4.55 4.56c.05.16.07.33.07.52 0 1.1-.9 2-2 2s-2-.9-2-2c0-.19.02-.36.07-.52l-2.55-2.55C4.35 12.98 4.18 13 4 13c-1.1 0-2-.9-2-2s.9-2 2-2c.18 0 .35.02.51.07l3.56-3.55C8.02 5.33 8 5.16 8 4.97c0-1.1.9-2 2-2s2 .9 2 2c0 .19-.02.36-.07.52l2.55 2.55c.16-.05.33-.07.52-.07s.36.02.52.07l4.55-4.56C17.98 3.33 18 3.16 18 2.97c0-1.1.9-2 2-2s2 .9 2 2c0 .19-.02.36-.07.52l2.55 2.55c.16-.05.33-.07.52-.07 1.1 0 2 .9 2 2z"/></symbol>
        <symbol id="icon-cols" viewBox="0 0 24 24"><path fill="currentColor" d="M4 5v13h17V5H4zm2 11V7h5v9H6zm7 0V7h5v9h-5z"/></symbol>
    </svg>

    <div id="app">
        <aside id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <div class="logo-area"><span class="logo-icon">F</span> FlowUs Pro</div>
                <button class="icon-btn" onclick="App.createPage()"><svg><use href="#icon-plus"/></svg></button>
            </div>
            <div id="page-list" class="sidebar-list"></div>
            <div class="sidebar-section-title mt-4">å¤§çº²ç›®å½•</div>
            <div id="toc-list" class="sidebar-list toc-list"></div>
            <div class="sidebar-footer">
                <div class="sidebar-item" onclick="App.toggleTheme()">
                    <svg class="icon"><use href="#icon-moon"/></svg><span>å¤–è§‚æ¨¡å¼</span>
                </div>
            </div>
        </aside>

        <main id="main">
            <header class="top-bar">
                <div class="breadcrumbs">
                    <span class="logo-icon icon-small" style="margin-right:8px">ğŸ“„</span>
                    <span id="breadcrumb-title">åŠ è½½ä¸­...</span>
                </div>
                <div class="top-actions">
                    <span id="save-status" style="font-size:12px;color:var(--text-tertiary);">å·²ä¿å­˜</span>
                    <button class="icon-btn" onclick="App.deleteCurrentPage()"><svg><use href="#icon-trash"/></svg></button>
                </div>
            </header>

            <div class="editor-scroller">
                <div class="editor-container">
                    <input type="text" id="page-title" class="page-title-input" placeholder="æ— æ ‡é¢˜" autocomplete="off">
                    <div id="blocks-container" class="blocks-container"></div>
                    <div class="editor-bottom-trigger" onclick="App.appendBlock()"></div>
                </div>
            </div>

            <footer class="bottom-stats-bar">
                <span id="word-count">0 å­—</span><span style="color:var(--border-light)">|</span>
                <span id="block-count">0 å—</span><span style="color:var(--border-light)">|</span>
                <span id="update-time">åˆšåˆš</span>
            </footer>
        </main>
    </div>

    <div id="slash-menu" class="popup-menu" style="display: none;">
        <div class="menu-header">åŸºç¡€</div>
        <div class="menu-item" onclick="App.transformBlock('text')"><span class="menu-icon">T</span> æ–‡æœ¬</div>
        <div class="menu-item" onclick="App.transformBlock('h1')"><span class="menu-icon">H1</span> ä¸€çº§æ ‡é¢˜</div>
        <div class="menu-item" onclick="App.transformBlock('h2')"><span class="menu-icon">H2</span> äºŒçº§æ ‡é¢˜</div>
        <div class="menu-item" onclick="App.transformBlock('todo')"><span class="menu-icon">â˜‘</span> å¾…åŠåˆ—è¡¨</div>
        <div class="menu-header">é«˜çº§</div>
        <div class="menu-item" onclick="App.transformBlock('timeline')"><span class="menu-icon"><svg class="icon-small"><use href="#icon-timeline"/></svg></span> é«˜çº§æ—¶é—´è½´</div>
        <div class="menu-item" onclick="App.transformBlock('table')"><span class="menu-icon"><svg class="icon-small"><use href="#icon-table"/></svg></span> è¡¨æ ¼</div>
        <div class="menu-item" onclick="App.transformBlock('cols')"><span class="menu-icon"><svg class="icon-small"><use href="#icon-cols"/></svg></span> åˆ†æ </div>
    </div>
    
    <div id="block-menu" class="popup-menu" style="display: none;">
        <div class="menu-item delete" onclick="App.deleteCurrentBlock()">
            <svg class="icon-small"><use href="#icon-trash"/></svg> åˆ é™¤æ­¤å—
        </div>
    </div>

    <script>
        (function() {
            "use strict";

            // 1. çŠ¶æ€ä¸å·¥å…·
            const State = {
                pages: [], currentPageId: null, currentBlocks: [], activeBlockId: null, menuContext: null,
                timelineState: {} // è®°å½•æ—¶é—´è½´æŠ˜å çŠ¶æ€
            };

            const Utils = {
                uuid: () => Date.now().toString(36) + Math.random().toString(36).substr(2),
                debounce: (fn, delay) => {
                    let timer;
                    return (...args) => { clearTimeout(timer); timer = setTimeout(() => fn(...args), delay); };
                },
                getWeekDay: (dateStr) => ['å‘¨æ—¥','å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”','å‘¨å…­'][new Date(dateStr).getDay()],
                countWords: (blocks) => blocks.reduce((acc, b) => acc + (b.content||'').length, 0)
            };

            // 2. æ•°æ®åº“
            const DB = {
                name: 'FlowUsLite_Fixed', version: 1, db: null,
                async init() {
                    return new Promise(resolve => {
                        const req = indexedDB.open(this.name, this.version);
                        req.onupgradeneeded = e => {
                            const db = e.target.result;
                            if(!db.objectStoreNames.contains('pages')) db.createObjectStore('pages', { keyPath: 'id' });
                        };
                        req.onsuccess = e => { this.db = e.target.result; resolve(); };
                    });
                },
                async getAll() {
                    return new Promise(resolve => {
                        const tx = this.db.transaction('pages', 'readonly');
                        resolve(new Promise(res => tx.objectStore('pages').getAll().onsuccess = e => res(e.target.result||[])));
                    });
                },
                async save(page) { const tx = this.db.transaction('pages', 'readwrite'); tx.objectStore('pages').put(page); },
                async delete(id) { const tx = this.db.transaction('pages', 'readwrite'); tx.objectStore('pages').delete(id); }
            };

            // 3. æ¸²æŸ“é€»è¾‘
            const Render = {
                sidebarList: document.getElementById('page-list'),
                tocList: document.getElementById('toc-list'),
                blocksContainer: document.getElementById('blocks-container'),
                
                sidebar() {
                    this.sidebarList.innerHTML = '';
                    State.pages.sort((a,b) => b.updatedAt - a.updatedAt).forEach(p => {
                        const el = document.createElement('div');
                        el.className = `sidebar-item ${p.id === State.currentPageId ? 'active' : ''}`;
                        el.innerHTML = `<svg class="icon-small" style="color:var(--text-secondary)"><use href="#icon-page"/></svg> <span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${p.title||'æ— æ ‡é¢˜'}</span>`;
                        el.onclick = () => App.loadPage(p.id);
                        this.sidebarList.appendChild(el);
                    });
                },

                toc(blocks) {
                    this.tocList.innerHTML = '';
                    blocks.forEach(b => {
                        if(b.type === 'h1' || b.type === 'h2') {
                            const el = document.createElement('div');
                            el.className = `sidebar-item ${b.type}`;
                            el.innerText = b.content || '(ç©º)';
                            el.onclick = () => {
                                const target = document.querySelector(`.content-block[data-id="${b.id}"]`);
                                if(target) target.scrollIntoView({behavior:'smooth'});
                            };
                            this.tocList.appendChild(el);
                        }
                    });
                },

                // æ ¸å¿ƒå—æ¸²æŸ“
                createBlockDOM(block) {
                    const wrapper = document.createElement('div');
                    wrapper.className = `content-block ${block.checked ? 'checked' : ''}`;
                    wrapper.dataset.id = block.id;

                    const handle = document.createElement('div');
                    handle.className = 'block-handle-area';
                    handle.innerHTML = `<svg><use href="#icon-drag"/></svg>`;
                    handle.onclick = (e) => App.openBlockMenu(e, block.id);
                    wrapper.appendChild(handle);

                    if(block.type === 'timeline') {
                        wrapper.appendChild(this.renderTimeline(block));
                    } else if(block.type === 'table') {
                        wrapper.innerHTML += `<div style="padding:10px;border:1px dashed #ddd;">è¡¨æ ¼å ä½ç¬¦ (åŠŸèƒ½ä¸æ—¶é—´è½´ç±»ä¼¼)</div>`;
                    } else if(block.type === 'cols') {
                         wrapper.innerHTML += `<div style="display:flex;gap:10px"><div style="flex:1;border:1px dashed #ddd;padding:10px">æ 1</div><div style="flex:1;border:1px dashed #ddd;padding:10px">æ 2</div></div>`;
                    } else {
                        // æ–‡æœ¬/æ ‡é¢˜/å¾…åŠ
                        if(block.type === 'todo') {
                            const checkWrap = document.createElement('div');
                            checkWrap.className = 'checkbox-wrapper';
                            checkWrap.innerHTML = `<div class="checkbox"></div>`;
                            checkWrap.onclick = () => App.toggleTodo(block.id);
                            wrapper.appendChild(checkWrap);
                        }
                        const content = document.createElement('div');
                        content.className = 'block-content';
                        content.contentEditable = true;
                        content.innerText = block.content;
                        if(block.type === 'text') content.dataset.placeholder = "è¾“å…¥ '/' æ’å…¥å†…å®¹";
                        if(block.type === 'h1') content.dataset.placeholder = "ä¸€çº§æ ‡é¢˜";
                        
                        // å­—ä½“å¤§å°ä¿®æ­£
                        if(block.type==='h1') content.style.fontSize='30px';
                        if(block.type==='h2') content.style.fontSize='24px';

                        content.oninput = (e) => App.handleInput(e, block.id);
                        content.onkeydown = (e) => App.handleKey(e, block.id);
                        wrapper.appendChild(content);
                    }
                    return wrapper;
                },

                // æ¸²æŸ“é«˜çº§æ—¶é—´è½´
                renderTimeline(block) {
                    const container = document.createElement('div');
                    container.className = 'timeline-v2-container';
                    
                    const toolbar = document.createElement('div');
                    toolbar.className = 'block-toolbar';
                    toolbar.innerHTML = `<span style="font-weight:bold;margin-right:8px">ğŸ“… é¡¹ç›®æ—¥ç¨‹</span><button class="toolbar-btn" onclick="App.addTimelineEvent('${block.id}')">+ æ–°äº‹ä»¶</button>`;
                    container.appendChild(toolbar);

                    if(!block.events || !Array.isArray(block.events)) {
                        block.events = [
                            { id: 1, title: 'é¡¹ç›®å¯åŠ¨', date: new Date().toISOString().split('T')[0], type: 'meeting', status: 'done', owner: 'User' }
                        ];
                    }

                    // åˆ†ç»„é€»è¾‘
                    const grouped = {};
                    block.events.forEach(ev => {
                        const d = new Date(ev.date);
                        if(isNaN(d)) return;
                        const y = d.getFullYear();
                        const m = d.getMonth()+1;
                        const k = ev.date;
                        if(!grouped[y]) grouped[y]={};
                        if(!grouped[y][m]) grouped[y][m]={};
                        if(!grouped[y][m][k]) grouped[y][m][k]=[];
                        grouped[y][m][k].push(ev);
                    });

                    const uiState = State.timelineState[block.id] || { collapsedYears: {} };

                    Object.keys(grouped).sort().forEach(year => {
                        const yearWrap = document.createElement('div');
                        yearWrap.className = 'tl-year-group';
                        if(uiState.collapsedYears[year]) yearWrap.classList.add('tl-group-collapsed');
                        
                        const yh = document.createElement('div');
                        yh.className = 'tl-year-header';
                        yh.innerHTML = `<svg class="tl-toggle-icon"><use href="#icon-chevron-down"/></svg> ${year}å¹´`;
                        yh.onclick = () => {
                            uiState.collapsedYears[year] = !uiState.collapsedYears[year];
                            State.timelineState[block.id] = uiState;
                            App.reloadBlock(block.id);
                        };
                        yearWrap.appendChild(yh);

                        const mList = document.createElement('div');
                        mList.className = 'tl-month-list';
                        
                        Object.keys(grouped[year]).sort((a,b)=>a-b).forEach(month => {
                            const mWrap = document.createElement('div');
                            mWrap.className = 'tl-month-group';
                            let count = 0; Object.values(grouped[year][month]).forEach(a=>count+=a.length);
                            
                            mWrap.innerHTML = `<div class="tl-month-header"><span>${month}æœˆ</span><span class="tl-month-badge">${count} äº‹ä»¶</span></div>`;
                            
                            Object.keys(grouped[year][month]).sort().forEach(dateStr => {
                                const row = document.createElement('div');
                                row.className = 'tl-day-row';
                                const dObj = new Date(dateStr);
                                
                                row.innerHTML = `<div class="tl-day-label"><div class="tl-day-num">${dObj.getDate()}æ—¥</div><div class="tl-day-week">${Utils.getWeekDay(dateStr)}</div></div>`;
                                
                                const evList = document.createElement('div');
                                evList.className = 'tl-event-list';
                                grouped[year][month][dateStr].forEach(ev => {
                                    const card = document.createElement('div');
                                    card.className = `event-card type-${ev.type||'task'}`;
                                    let icon = 'â—'; if(ev.type==='meeting') icon='â—‹'; if(ev.type==='milestone') icon='â˜…';
                                    
                                    card.innerHTML = `
                                        <div class="ec-header"><span class="ec-icon">${icon}</span><div class="ec-title" contenteditable="true">${ev.title}</div></div>
                                        <div class="ec-props">${ev.status?`<span class="ec-tag status-${ev.status}">${ev.status}</span>`:''}</div>
                                        <div class="ec-meta"><div class="ec-meta-item"><svg class="icon-small"><use href="#icon-clock"/></svg> ${ev.date}</div></div>
                                    `;
                                    card.querySelector('.ec-title').onblur = (e) => { ev.title = e.target.innerText; App.save(); };
                                    evList.appendChild(card);
                                });
                                
                                const addBtn = document.createElement('div');
                                addBtn.className = 'tl-add-btn'; addBtn.innerHTML='+ æ·»åŠ ';
                                addBtn.onclick = () => App.addTimelineEvent(block.id, dateStr);
                                evList.appendChild(addBtn);

                                row.appendChild(evList);
                                mWrap.appendChild(row);
                            });
                            mList.appendChild(mWrap);
                        });
                        yearWrap.appendChild(mList);
                        container.appendChild(yearWrap);
                    });
                    
                    if(Object.keys(grouped).length === 0) {
                        container.innerHTML += `<div style="padding:20px;text-align:center;color:#999">æš‚æ— äº‹ä»¶ï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ </div>`;
                    }

                    return container;
                },

                editor(blocks) {
                    this.blocksContainer.innerHTML = '';
                    blocks.forEach(b => this.blocksContainer.appendChild(this.createBlockDOM(b)));
                    document.getElementById('word-count').innerText = `${Utils.countWords(blocks)} å­—`;
                    document.getElementById('block-count').innerText = `${blocks.length} å—`;
                    this.toc(blocks);
                }
            };

            // 4. åº”ç”¨é€»è¾‘
            const App = {
                async init() {
                    await DB.init();
                    State.pages = await DB.getAll();
                    if(State.pages.length === 0) await this.createPage(true);
                    else this.loadPage(State.pages[0].id);

                    document.addEventListener('click', e => {
                        if(!e.target.closest('#slash-menu')) document.getElementById('slash-menu').style.display='none';
                        if(!e.target.closest('#block-menu') && !e.target.closest('.block-handle-area')) document.getElementById('block-menu').style.display='none';
                    });
                    document.getElementById('page-title').oninput = e => {
                        const p = State.pages.find(x=>x.id===State.currentPageId);
                        if(p) { p.title=e.target.value; this.save(); }
                    };
                },

                async createPage(isDemo) {
                    const page = {
                        id: Utils.uuid(), title: isDemo ? 'FlowUs æ—¶é—´è½´æ¼”ç¤º' : '', updatedAt: Date.now(),
                        blocks: isDemo ? [
                            {id: Utils.uuid(), type: 'h1', content: 'å‚ç›´æ—¶é—´è½´'},
                            {id: Utils.uuid(), type: 'timeline', events: null}
                        ] : [{id: Utils.uuid(), type: 'text', content: ''}]
                    };
                    await DB.save(page); State.pages.unshift(page); this.loadPage(page.id);
                },

                loadPage(id) {
                    State.currentPageId = id;
                    const p = State.pages.find(x=>x.id===id);
                    if(!p) return;
                    State.currentBlocks = JSON.parse(JSON.stringify(p.blocks));
                    document.getElementById('page-title').value = p.title;
                    document.getElementById('breadcrumb-title').innerText = p.title||'æ— æ ‡é¢˜';
                    Render.sidebar(); Render.editor(State.currentBlocks);
                },

                save: Utils.debounce(async function() {
                    if(!State.currentPageId) return;
                    const p = State.pages.find(x=>x.id===State.currentPageId);
                    p.blocks = State.currentBlocks; p.updatedAt = Date.now();
                    await DB.save(p); Render.sidebar();
                    document.getElementById('update-time').innerText = new Date().toLocaleTimeString();
                    const s = document.getElementById('save-status'); s.innerText='ä¿å­˜ä¸­...'; setTimeout(()=>s.innerText='å·²ä¿å­˜',800);
                }, 800),

                reloadBlock(id) { Render.editor(State.currentBlocks); },

                handleInput(e, id) {
                    const b = State.currentBlocks.find(x=>x.id===id); b.content = e.target.innerText; this.save();
                    if(e.target.innerText === '/') this.openSlashMenu(id);
                },
                handleKey(e, id) { if(e.key==='Enter' && !e.shiftKey) { e.preventDefault(); this.appendBlock(id); } },
                
                appendBlock(id) {
                    const nb = {id: Utils.uuid(), type: 'text', content: ''};
                    if(id) {
                        const idx = State.currentBlocks.findIndex(x=>x.id===id); State.currentBlocks.splice(idx+1, 0, nb);
                    } else { State.currentBlocks.push(nb); }
                    Render.editor(State.currentBlocks);
                    setTimeout(()=>document.querySelector(`.content-block[data-id="${nb.id}"] .block-content`)?.focus(),0);
                    this.save();
                },

                openSlashMenu(id) {
                    State.menuContext = id;
                    const m = document.getElementById('slash-menu');
                    const r = document.querySelector(`.content-block[data-id="${id}"]`).getBoundingClientRect();
                    m.style.display='block'; m.style.left=(r.left+20)+'px'; m.style.top=(r.bottom+5)+'px';
                },
                transformBlock(type) {
                    const b = State.currentBlocks.find(x=>x.id===State.menuContext);
                    if(b) { b.type=type; if(b.content) b.content=b.content.replace('/',''); Render.editor(State.currentBlocks); this.save(); }
                    document.getElementById('slash-menu').style.display='none';
                },

                addTimelineEvent(blockId, dateStr) {
                    const b = State.currentBlocks.find(x=>x.id===blockId);
                    if(!b) return;
                    const d = dateStr || new Date().toISOString().split('T')[0];
                    b.events.push({ id: Utils.uuid(), title: 'æ–°äº‹ä»¶', date: d, type: 'task', status: 'todo' });
                    Render.editor(State.currentBlocks); this.save();
                },

                openBlockMenu(e, id) {
                    e.stopPropagation(); State.activeBlockId = id;
                    const m = document.getElementById('block-menu');
                    m.style.display='block'; m.style.left=e.clientX+'px'; m.style.top=e.clientY+'px';
                },
                deleteCurrentBlock() {
                    if(State.activeBlockId) {
                        const idx = State.currentBlocks.findIndex(x=>x.id===State.activeBlockId);
                        State.currentBlocks.splice(idx,1); Render.editor(State.currentBlocks); this.save();
                    }
                    document.getElementById('block-menu').style.display='none';
                },
                toggleTodo(id) {
                    const b = State.currentBlocks.find(x=>x.id===id); b.checked = !b.checked; Render.editor(State.currentBlocks); this.save();
                },
                deleteCurrentPage() { if(confirm('åˆ é™¤æ­¤é¡µ?')) DB.delete(State.currentPageId).then(()=>location.reload()); },
                toggleTheme() { document.body.setAttribute('data-theme', document.body.getAttribute('data-theme')==='dark'?'':'dark'); }
            };

            window.App = App;
            window.onload = () => App.init();
        })();
    </script>
</body>
</html>