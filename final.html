<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlowUs Pro V7 - æœ¬åœ°æ–‡ä»¶ç‰ˆ</title>
    <style>
        /* ================= 1. æ ¸å¿ƒè®¾è®¡ç³»ç»Ÿ (ç¾åŒ–ç‰ˆ) ================= */
        :root {
            /* è‰²å½©ç³»ç»Ÿ - æ›´æŸ”å’Œæ›´ç°ä»£ */
            --bg-body: #ffffff;
            --bg-sidebar: #f7f9fb;
            --bg-panel: #ffffff;
            --bg-hover: #f0f2f5;
            --bg-active: #e6f0ff;
            
            --text-main: #202124;
            --text-sub: #5f6368;
            --text-hint: #9aa0a6;
            
            --accent: #2979ff; /* æ›´é²œäº®çš„è“ */
            --accent-hover: #2962ff;
            --danger: #ff5252;
            --success: #00c853;
            --border: #e0e0e0;
            
            /* é˜´å½±ä¸åœ†è§’ */
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
            --radius-sm: 6px;
            --radius-md: 8px;
            
            /* å°ºå¯¸ */
            --sidebar-w: 260px;
            --header-h: 52px;
            --content-w: 960px;
        }

        [data-theme="dark"] {
            --bg-body: #121212;
            --bg-sidebar: #1e1e1e;
            --bg-panel: #252525;
            --bg-hover: #2c2c2c;
            --bg-active: #1e2a3a;
            --text-main: #e8eaed;
            --text-sub: #9aa0a6;
            --text-hint: #5f6368;
            --border: #3c4043;
        }

        * { box-sizing: border-box; outline: none; }
        body { margin: 0; height: 100vh; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg-body); color: var(--text-main); overflow: hidden; }
        
        /* å›¾æ ‡ç»Ÿä¸€ç¾åŒ– */
        svg { width: 20px; height: 20px; fill: currentColor; display: block; opacity: 0.8; transition: opacity 0.2s; }
        .icon-btn:hover svg { opacity: 1; }
        .icon-sm { width: 16px; height: 16px; }

        /* ================= 2. å¯åŠ¨é¡µ (Welcome Screen) ================= */
        #welcome-screen {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 9999;
            background: var(--bg-body); display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .welcome-card {
            width: 400px; padding: 40px; background: var(--bg-panel); border: 1px solid var(--border);
            border-radius: var(--radius-md); box-shadow: var(--shadow-lg); text-align: center;
        }
        .welcome-title { font-size: 24px; font-weight: 700; margin-bottom: 8px; color: var(--text-main); }
        .welcome-sub { font-size: 14px; color: var(--text-sub); margin-bottom: 32px; }
        .welcome-btn {
            display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%;
            padding: 12px; margin-bottom: 12px; border-radius: var(--radius-sm);
            border: 1px solid var(--border); background: var(--bg-body); cursor: pointer;
            font-size: 14px; font-weight: 500; transition: all 0.2s;
        }
        .welcome-btn:hover { background: var(--bg-hover); border-color: var(--accent); color: var(--accent); }
        .welcome-btn.primary { background: var(--accent); color: white; border: none; }
        .welcome-btn.primary:hover { background: var(--accent-hover); }

        /* ================= 3. ä¸»å¸ƒå±€ ================= */
        #app { display: none; height: 100vh; width: 100vw; } /* åˆå§‹éšè—ï¼Œæ–‡ä»¶åŠ è½½åæ˜¾ç¤º */
        
        .sidebar { width: var(--sidebar-w); background: var(--bg-sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .sidebar-header { height: var(--header-h); display: flex; align-items: center; justify-content: space-between; padding: 0 16px; font-weight: 600; font-size: 15px; border-bottom: 1px solid transparent; }
        .sidebar-list { flex: 1; overflow-y: auto; padding: 12px; }
        .sidebar-item { padding: 8px 12px; margin-bottom: 2px; border-radius: var(--radius-sm); cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 14px; color: var(--text-main); }
        .sidebar-item:hover { background: var(--bg-hover); }
        .sidebar-item.active { background: var(--bg-active); color: var(--accent); font-weight: 500; }
        .sidebar-footer { padding: 16px; border-top: 1px solid var(--border); font-size: 12px; color: var(--text-hint); text-align: center; }

        #main { flex: 1; display: flex; flex-direction: column; position: relative; background: var(--bg-body); }
        .top-bar { height: var(--header-h); display: flex; align-items: center; justify-content: space-between; padding: 0 32px; border-bottom: 1px solid transparent; transition: border-color 0.2s; }
        #main:hover .top-bar { border-bottom-color: var(--border); }
        
        .editor-scroller { flex: 1; overflow-y: auto; scroll-behavior: smooth; }
        .editor-container { max-width: var(--content-width); margin: 0 auto; padding: 60px 40px 150px; }
        
        .page-title { width: 100%; border: none; background: transparent; font-size: 32px; font-weight: 700; color: var(--text-main); margin-bottom: 32px; line-height: 1.3; }
        
        /* æŒ‰é’®é€šç”¨ */
        .icon-btn { background: transparent; border: none; padding: 6px; border-radius: var(--radius-sm); color: var(--text-sub); cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .icon-btn:hover { background: var(--bg-hover); color: var(--text-main); }
        .btn-sm { padding: 4px 8px; border-radius: 4px; background: var(--bg-panel); border: 1px solid var(--border); font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 4px; color: var(--text-sub); }
        .btn-sm:hover { border-color: var(--text-sub); color: var(--text-main); }

        /* ================= 4. å†…å®¹å—ç³»ç»Ÿ ================= */
        .block-wrapper { position: relative; margin: 4px 0; padding: 2px 0; display: flex; align-items: flex-start; group; }
        
        /* å·¦ä¾§æ‚¬æµ®æ“ä½œåŒº (Gutter) */
        .gutter {
            position: absolute; left: -50px; top: 2px; width: 46px; height: 24px;
            display: flex; align-items: center; justify-content: flex-end; gap: 2px;
            opacity: 0; transition: opacity 0.15s;
        }
        .block-wrapper:hover .gutter { opacity: 1; }
        .gutter-item { width: 20px; height: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-hint); border-radius: 4px; }
        .gutter-item:hover { background: var(--bg-hover); color: var(--text-main); }
        .handle { cursor: grab; }

        .block-content { 
            flex: 1; min-height: 24px; font-size: 16px; line-height: 1.6; word-break: break-word; 
            outline: none; padding: 0 4px; border-radius: 4px; 
        }
        .block-content:empty::before { content: attr(placeholder); color: var(--text-hint); pointer-events: none; }
        [data-type="h1"] .block-content { font-size: 28px; font-weight: 700; margin-top: 24px; margin-bottom: 8px; }
        
        /* å¾…åŠ */
        .todo-wrap { display: flex; align-items: flex-start; gap: 8px; width: 100%; }
        .checkbox { 
            width: 18px; height: 18px; border: 2px solid var(--text-hint); border-radius: 4px; 
            margin-top: 4px; cursor: pointer; flex-shrink: 0; position: relative; transition: all 0.2s;
        }
        .block-wrapper.checked .checkbox { background: var(--accent); border-color: var(--accent); }
        .block-wrapper.checked .checkbox::after {
            content: ''; position: absolute; left: 5px; top: 1px; width: 4px; height: 9px;
            border: solid white; border-width: 0 2px 2px 0; transform: rotate(45deg);
        }
        .block-wrapper.checked .block-content { text-decoration: line-through; color: var(--text-hint); }

        /* ================= 5. å¤æ‚æ¨¡å—å®¹å™¨ ================= */
        .module-card {
            width: 100%; margin: 12px 0; background: var(--bg-panel); border: 1px solid var(--border);
            border-radius: var(--radius-md); overflow: hidden; box-shadow: var(--shadow-sm);
        }
        .module-toolbar {
            display: flex; align-items: center; justify-content: space-between; padding: 8px 12px;
            background: var(--bg-sidebar); border-bottom: 1px solid var(--border);
        }
        .module-title { font-size: 13px; font-weight: 600; color: var(--text-main); border: none; background: transparent; }
        
        /* å‚ç›´æ—¶é—´è½´ */
        .v-timeline { padding: 20px 24px; position: relative; }
        .v-timeline::before { content: ''; position: absolute; left: 29px; top: 24px; bottom: 24px; width: 2px; background: var(--border); }
        .vt-item { display: flex; gap: 16px; margin-bottom: 16px; position: relative; }
        .vt-dot { 
            width: 12px; height: 12px; background: var(--bg-panel); border: 2px solid var(--accent); 
            border-radius: 50%; z-index: 1; margin-top: 6px; flex-shrink: 0;
        }
        .vt-card { flex: 1; padding: 12px; background: var(--bg-sidebar); border-radius: var(--radius-sm); border: 1px solid transparent; transition: all 0.2s; }
        .vt-card:hover { background: var(--bg-panel); border-color: var(--border); box-shadow: var(--shadow-sm); }
        .vt-header { font-weight: 600; font-size: 14px; margin-bottom: 4px; }
        .vt-meta { font-size: 12px; color: var(--text-sub); display: flex; gap: 10px; }

        /* æ¨ªå‘æ—¶é—´è½´ (Gantt) */
        .gantt-container { height: 320px; display: flex; flex-direction: column; user-select: none; }
        .gantt-fullscreen { position: fixed; top:0; left:0; w:100vw; h:100vh; z-index:5000; background:var(--bg-body); padding:20px; }
        .gantt-fullscreen .gantt-container { height: 100%; border: 1px solid var(--border); border-radius: var(--radius-md); }
        
        .gantt-header { height: 40px; display: flex; border-bottom: 1px solid var(--border); background: var(--bg-sidebar); }
        .gantt-corner { width: 160px; border-right: 1px solid var(--border); flex-shrink: 0; display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:bold; color:var(--text-sub); }
        .gantt-scale { flex: 1; overflow: hidden; display: flex; }
        .gantt-cell { border-right: 1px solid var(--border); display:flex; align-items:center; justify-content:center; font-size:12px; color:var(--text-sub); flex-shrink:0; }
        
        .gantt-body { flex: 1; display: flex; overflow: auto; position: relative; }
        .gantt-tracks { width: 160px; flex-shrink: 0; border-right: 1px solid var(--border); background: var(--bg-panel); position: sticky; left: 0; z-index: 2; }
        .gantt-track { height: 48px; border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 12px; font-size: 13px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .gantt-grid { flex: 1; position: relative; min-width: max-content; background-image: linear-gradient(90deg, var(--border) 1px, transparent 1px); background-size: 60px 100%; }
        .gantt-row { height: 48px; border-bottom: 1px solid var(--border); }
        .gantt-row:nth-child(even) { background: rgba(0,0,0,0.01); }
        
        /* äº¤äº’å¼äº‹ä»¶æ¡ */
        .gantt-bar {
            position: absolute; top: 10px; height: 28px; border-radius: 4px; background: var(--accent);
            color: white; font-size: 12px; padding: 0 8px; display: flex; align-items: center;
            box-shadow: var(--shadow-sm); cursor: pointer; overflow: hidden; white-space: nowrap;
            transition: box-shadow 0.2s;
        }
        .gantt-bar:hover { box-shadow: var(--shadow-md); z-index: 10; }
        .gantt-bar.dragging { opacity: 0.8; cursor: grabbing; box-shadow: var(--shadow-lg); z-index: 100; transition: none; }
        
        .resize-handle { position: absolute; top:0; bottom:0; width: 10px; cursor: col-resize; z-index: 20; }
        .resize-handle:hover { background: rgba(255,255,255,0.3); }
        .resize-handle.left { left: 0; } .resize-handle.right { right: 0; }

        /* ç¼–è¾‘å¼¹çª— Modal */
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.3); z-index: 6000; display:none; align-items:center; justify-content:center; }
        .modal { background: var(--bg-panel); padding: 24px; border-radius: var(--radius-md); width: 320px; box-shadow: var(--shadow-lg); }
        .modal h3 { margin: 0 0 16px 0; font-size: 16px; }
        .form-group { margin-bottom: 12px; }
        .form-label { display: block; font-size: 12px; color: var(--text-sub); margin-bottom: 4px; }
        .form-input { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg-body); color: var(--text-main); }
        .modal-actions { display: flex; justify-content: flex-end; gap: 8px; margin-top: 20px; }

        /* ================= 6. èœå•ä¸è¾…åŠ© ================= */
        .popup-menu {
            position: fixed; z-index: 5000; background: var(--bg-panel); border: 1px solid var(--border);
            box-shadow: var(--shadow-lg); border-radius: var(--radius-md); width: 220px; padding: 6px 0;
            max-height: 300px; overflow-y: auto; opacity: 0; pointer-events: none; transition: opacity 0.15s;
        }
        .popup-menu.show { opacity: 1; pointer-events: auto; }
        .menu-head { padding: 6px 12px; font-size: 11px; font-weight: 700; color: var(--text-sub); background: var(--bg-sidebar); }
        .menu-item { padding: 8px 12px; display: flex; align-items: center; gap: 10px; font-size: 14px; cursor: pointer; color: var(--text-main); }
        .menu-item:hover { background: var(--bg-active); color: var(--accent); }

        .bottom-trigger { height: 200px; display: flex; align-items: center; justify-content: center; color: var(--text-hint); cursor: text; margin-top: 20px; transition: color 0.2s; }
        .bottom-trigger:hover { color: var(--text-sub); }
        .bottom-trigger::after { content: "ç‚¹å‡»æ­¤å¤„åœ¨æœ«å°¾æ·»åŠ å†…å®¹"; }
    </style>
</head>
<body>

    <svg style="display: none;">
        <symbol id="i-plus" viewBox="0 0 256 256"><path d="M224,128a8,8,0,0,1-8,8H136v80a8,8,0,0,1-16,0V136H40a8,8,0,0,1,0-16h80V40a8,8,0,0,1,16,0v80h80A8,8,0,0,1,224,128Z"/></symbol>
        <symbol id="i-dots" viewBox="0 0 256 256"><path d="M104,60A12,12,0,1,1,92,48,12,12,0,0,1,104,60Zm56,0A12,12,0,1,1,148,48,12,12,0,0,1,160,60ZM92,116a12,12,0,1,0,12,12A12,12,0,0,0,92,116Zm68,0a12,12,0,1,0,12,12A12,12,0,0,0,160,116ZM92,184a12,12,0,1,0,12,12A12,12,0,0,0,92,184Zm68,0a12,12,0,1,0,12,12A12,12,0,0,0,160,184Z"/></symbol>
        <symbol id="i-trash" viewBox="0 0 256 256"><path d="M216,48H176V40a24,24,0,0,0-24-24H104A24,24,0,0,0,80,40v8H40a8,8,0,0,0,0,16h8V208a16,16,0,0,0,16,16H192a16,16,0,0,0,16-16V64h8a8,8,0,0,0,0-16ZM96,40a8,8,0,0,1,8-8h48a8,8,0,0,1,8,8v8H96Zm96,168H64V64H192ZM112,104v64a8,8,0,0,1-16,0V104a8,8,0,0,1,16,0Zm48,0v64a8,8,0,0,1-16,0V104a8,8,0,0,1,16,0Z"/></symbol>
        <symbol id="i-file" viewBox="0 0 256 256"><path d="M213.66,82.34l-56-56A8,8,0,0,0,152,24H56A16,16,0,0,0,40,40V216a16,16,0,0,0,16,16H200a16,16,0,0,0,16-16V88A8,8,0,0,0,213.66,82.34ZM160,51.31,188.69,80H160ZM200,216H56V40h88V88a8,8,0,0,0,8,8h48V216Z"/></symbol>
        <symbol id="i-save" viewBox="0 0 256 256"><path d="M208,32H48A16,16,0,0,0,32,48V208a16,16,0,0,0,16,16H208a16,16,0,0,0,16-16V48A16,16,0,0,0,208,32Zm-32,16v48H80V48Zm16,160H64V128H192ZM192,48v48H192Z"/></symbol>
        <symbol id="i-open" viewBox="0 0 256 256"><path d="M216,72H173.31l-26.63-26.63A16,16,0,0,0,135.37,40H56A16,16,0,0,0,40,56V200a16,16,0,0,0,16,16H216a16,16,0,0,0,16-16V88A16,16,0,0,0,216,72Zm0,128H56V56h79.37L164.69,85.37A16,16,0,0,0,176,88h40Z"/></symbol>
    </svg>

    <div id="welcome-screen">
        <div class="welcome-card">
            <h1 class="welcome-title">FlowUs Lite Pro V7</h1>
            <p class="welcome-sub">æœ¬åœ°åŒ– Â· å®‰å…¨ Â· é«˜æ•ˆçš„é¡¹ç›®ç®¡ç†</p>
            <button class="welcome-btn primary" onclick="App.initNew()">
                <svg><use href="#i-plus"/></svg> æ–°å»ºæœ¬åœ°é¡¹ç›®
            </button>
            <button class="welcome-btn" onclick="App.initOpen()">
                <svg><use href="#i-open"/></svg> æ‰“å¼€ .json æ–‡ä»¶
            </button>
        </div>
    </div>

    <div id="app">
        <aside class="sidebar">
            <div class="sidebar-header">
                <span>é¡¹ç›®æ–‡ä»¶</span>
                <div class="icon-btn" onclick="App.createPage()" title="æ–°å»ºé¡µé¢"><svg><use href="#i-plus"/></svg></div>
            </div>
            <div id="page-list" class="sidebar-list"></div>
            <div class="sidebar-footer">
                <span id="file-status">æœªä¿å­˜æ–‡ä»¶</span>
            </div>
        </aside>

        <main id="main">
            <header class="top-bar">
                <div id="breadcrumb" style="font-size:14px; color:var(--text-sub);"></div>
                <div style="display:flex; gap:8px;">
                    <button class="btn-sm" onclick="FileIO.saveFile()">
                        <svg class="icon-sm"><use href="#i-save"/></svg> ä¿å­˜ (Ctrl+S)
                    </button>
                    <button class="icon-btn" onclick="App.deletePage()"><svg><use href="#i-trash"/></svg></button>
                </div>
            </header>

            <div class="editor-scroller" onclick="App.focusEditor(event)">
                <div class="editor-container">
                    <input type="text" id="page-title" class="page-title" placeholder="æ— æ ‡é¢˜é¡µé¢">
                    <div id="blocks-container"></div>
                    <div class="bottom-trigger" onclick="event.stopPropagation(); App.appendBlock()"></div>
                </div>
            </div>
        </main>
    </div>

    <div id="slash-menu" class="popup-menu">
        <div class="menu-head">åŸºç¡€å†…å®¹</div>
        <div class="menu-item" onclick="App.transform('text')">ğŸ“„ æ–‡æœ¬</div>
        <div class="menu-item" onclick="App.transform('h1')">H1 ä¸€çº§æ ‡é¢˜</div>
        <div class="menu-item" onclick="App.transform('todo')">â˜‘ å¾…åŠäº‹é¡¹</div>
        <div class="menu-item" onclick="App.createSubPage()">ğŸ“‚ å­é¡µé¢</div>
        <div class="menu-head">é«˜çº§è§†å›¾</div>
        <div class="menu-item" onclick="App.transform('timeline-v')">â± å‚ç›´æ—¶é—´è½´</div>
        <div class="menu-item" onclick="App.transform('timeline-h')">ğŸ“… æ¨ªå‘ç”˜ç‰¹å›¾</div>
        <div class="menu-item" onclick="App.transform('table')">â–¦ æ™ºèƒ½è¡¨æ ¼</div>
    </div>

    <div id="event-modal" class="modal-overlay">
        <div class="modal">
            <h3>ç¼–è¾‘äº‹ä»¶</h3>
            <div class="form-group">
                <label class="form-label">æ ‡é¢˜</label>
                <input id="ev-title" class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label">å¼€å§‹æ—¶é—´</label>
                <input type="date" id="ev-start" class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label">æŒç»­å¤©æ•°</label>
                <input type="number" id="ev-duration" class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label">é¢œè‰²</label>
                <select id="ev-color" class="form-input">
                    <option value="#4285f4">è“è‰²</option>
                    <option value="#34a853">ç»¿è‰²</option>
                    <option value="#fbbc04">é»„è‰²</option>
                    <option value="#ea4335">çº¢è‰²</option>
                    <option value="#9c27b0">ç´«è‰²</option>
                </select>
            </div>
            <div class="modal-actions">
                <button class="btn-sm" onclick="Modal.close()">å–æ¶ˆ</button>
                <button class="btn-sm" style="background:var(--accent);color:white;border:none" onclick="Modal.save()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script>
        (function() {
            "use strict";

            // --- çŠ¶æ€ç®¡ç† ---
            const State = {
                pages: [], 
                currentPageId: null, 
                menuTargetId: null,
                // æ‹–æ‹½çŠ¶æ€
                dragging: { active: false, type: null, blockId: null, eventId: null, startX: 0, startLeft: 0, startWidth: 0, unitWidth: 60, dayWidthMs: 86400000 },
                // å—æ’åº
                blockDrag: { src: null, dest: null }
            };

            // --- å·¥å…· ---
            const Utils = {
                uuid: () => Date.now().toString(36) + Math.random().toString(36).substr(2),
                dateDiff: (d1, d2) => Math.ceil((new Date(d2) - new Date(d1)) / (1000 * 60 * 60 * 24)),
                addDays: (d, n) => { const x = new Date(d); x.setDate(x.getDate() + n); return x; }
            };

            // --- æ–‡ä»¶ç³»ç»Ÿ (æ ¸å¿ƒå‡çº§) ---
            const FileIO = {
                handle: null,
                async initNew() {
                    State.pages = [{ id: Utils.uuid(), title: 'æ–°é¡¹ç›®', parentId: null, updatedAt: Date.now(), blocks: [] }];
                    this.launch();
                },
                async initOpen() {
                    try {
                        [this.handle] = await window.showOpenFilePicker({ types: [{ description: 'FlowUs JSON', accept: {'application/json': ['.json']} }] });
                        const file = await this.handle.getFile();
                        const text = await file.text();
                        State.pages = JSON.parse(text);
                        this.launch();
                    } catch(e) { console.log('å–æ¶ˆæ‰“å¼€'); }
                },
                launch() {
                    document.getElementById('welcome-screen').style.display = 'none';
                    document.getElementById('app').style.display = 'flex';
                    App.loadPage(State.pages[0].id);
                    this.updateStatus();
                },
                async saveFile() {
                    if (!this.handle) {
                        try {
                            this.handle = await window.showSaveFilePicker({ types: [{ description: 'FlowUs JSON', accept: {'application/json': ['.json']} }] });
                        } catch(e) { return; }
                    }
                    const writable = await this.handle.createWritable();
                    await writable.write(JSON.stringify(State.pages));
                    await writable.close();
                    this.updateStatus("å·²ä¿å­˜");
                },
                updateStatus(msg) {
                    const el = document.getElementById('file-status');
                    el.innerText = msg || (this.handle ? this.handle.name : "æœªä¿å­˜ (ä»…å†…å­˜)");
                    el.style.color = msg === "å·²ä¿å­˜" ? "var(--success)" : "var(--text-hint)";
                }
            };

            // --- æ¸²æŸ“å¼•æ“ ---
            const Render = {
                sidebar() {
                    const list = document.getElementById('page-list'); list.innerHTML = '';
                    State.pages.forEach(p => {
                        const div = document.createElement('div');
                        div.className = `sidebar-item ${p.id === State.currentPageId ? 'active' : ''}`;
                        div.innerHTML = `<svg class="icon-sm"><use href="#i-file"/></svg> ${p.title || 'æ— æ ‡é¢˜'}`;
                        div.onclick = () => App.loadPage(p.id);
                        list.appendChild(div);
                    });
                },
                editor(blocks) {
                    const container = document.getElementById('blocks-container'); container.innerHTML = '';
                    blocks.forEach(b => container.appendChild(this.createBlock(b)));
                },
                createBlock(block) {
                    const wrap = document.createElement('div');
                    wrap.className = 'block-wrapper'; wrap.dataset.id = block.id;
                    
                    // æ‹–æ‹½æ’åºå±æ€§
                    wrap.draggable = true;
                    wrap.ondragstart = (e) => { State.blockDrag.src = block.id; wrap.style.opacity = 0.5; };
                    wrap.ondragend = () => { wrap.style.opacity = 1; document.querySelectorAll('.drop-target').forEach(el=>el.classList.remove('drop-target')); };
                    wrap.ondragover = (e) => { e.preventDefault(); wrap.classList.add('drop-target'); };
                    wrap.ondragleave = () => wrap.classList.remove('drop-target');
                    wrap.ondrop = (e) => { e.preventDefault(); App.reorderBlock(State.blockDrag.src, block.id); };

                    // å·¦ä¾§ Gutter
                    const gutter = document.createElement('div'); gutter.className = 'gutter';
                    const addBtn = document.createElement('div'); addBtn.className = 'gutter-item';
                    addBtn.innerHTML = '<svg><use href="#i-plus"/></svg>';
                    addBtn.onclick = (e) => Menu.open(e, block.id);
                    const dragBtn = document.createElement('div'); dragBtn.className = 'gutter-item handle';
                    dragBtn.innerHTML = '<svg><use href="#i-dots"/></svg>';
                    gutter.append(addBtn, dragBtn);
                    wrap.appendChild(gutter);

                    // å†…å®¹æ¸²æŸ“
                    if(block.type === 'text' || block.type === 'h1' || block.type === 'todo') {
                        if(block.type === 'todo') {
                            wrap.classList.add(block.checked ? 'checked' : 'unchecked');
                            const cb = document.createElement('div'); cb.className='checkbox';
                            cb.onclick = (e) => { e.stopPropagation(); App.toggleTodo(block.id); };
                            const cw = document.createElement('div'); cw.className='todo-wrap';
                            cw.appendChild(cb);
                            const content = this.createInput(block);
                            cw.appendChild(content);
                            wrap.appendChild(cw);
                        } else {
                            wrap.dataset.type = block.type;
                            wrap.appendChild(this.createInput(block));
                        }
                    } else if (block.type === 'timeline-h') {
                        wrap.appendChild(this.renderGantt(block));
                    } else if (block.type === 'timeline-v') {
                        wrap.appendChild(this.renderVTimeline(block));
                    } else if (block.type === 'table') {
                        wrap.appendChild(this.renderTable(block));
                    } else if (block.type === 'page') {
                        wrap.appendChild(this.renderSubPage(block));
                    }
                    return wrap;
                },
                createInput(block) {
                    const div = document.createElement('div');
                    div.className = 'block-content'; div.contentEditable = true;
                    div.innerText = block.content;
                    if(block.type==='text') div.setAttribute('placeholder', "è¾“å…¥ '/' å”¤èµ·èœå•");
                    if(block.type==='h1') div.setAttribute('placeholder', "ä¸€çº§æ ‡é¢˜");
                    div.oninput = (e) => { 
                        block.content = e.target.innerText; 
                        if(e.target.innerText === '/') Menu.open(null, block.id, e.target);
                    };
                    div.onkeydown = (e) => { if(e.key === 'Enter') { e.preventDefault(); App.addBlock(block.id); } };
                    return div;
                },
                renderSubPage(block) {
                    const div = document.createElement('div'); div.className = 'subpage-block module-card';
                    div.style.padding = "10px"; div.style.cursor = "pointer";
                    const p = State.pages.find(x => x.id === block.pageId);
                    div.innerHTML = `ğŸ“„ <span style="text-decoration:underline">${p ? p.title : 'å·²åˆ é™¤é¡µé¢'}</span>`;
                    div.onclick = () => App.loadPage(block.pageId);
                    return div;
                },
                renderVTimeline(block) {
                    const card = document.createElement('div'); card.className = 'module-card';
                    card.innerHTML = `<div class="module-toolbar"><input class="module-title" value="${block.name||'å‚ç›´æ—¶é—´è½´'}" onchange="App.updBlock(this,'${block.id}','name')"><button class="btn-sm" onclick="App.addVItem('${block.id}')">+ èŠ‚ç‚¹</button></div>`;
                    const con = document.createElement('div'); con.className = 'v-timeline';
                    (block.events||[]).forEach((ev, i) => {
                        con.innerHTML += `<div class="vt-item"><div class="vt-dot"></div><div class="vt-card"><div class="vt-header" contenteditable onblur="App.updVItem('${block.id}',${i},'title',this.innerText)">${ev.title}</div><div class="vt-meta"><span contenteditable onblur="App.updVItem('${block.id}',${i},'date',this.innerText)">${ev.date}</span></div></div></div>`;
                    });
                    card.appendChild(con); return card;
                },
                renderTable(block) {
                    const card = document.createElement('div'); card.className = 'module-card';
                    card.innerHTML = `<div class="module-toolbar"><input class="module-title" value="${block.name||'è¡¨æ ¼'}" onchange="App.updBlock(this,'${block.id}','name')"><div><button class="btn-sm" onclick="App.tableRow('${block.id}')">+ è¡Œ</button></div></div>`;
                    const tcon = document.createElement('div'); tcon.className='flowus-table-container';
                    let html = `<table class="flowus-table"><thead><tr><th>A</th><th>B</th><th>C</th></tr></thead><tbody>`;
                    (block.data||[['','','']]).forEach((row, r) => {
                        html += `<tr>${row.map((c,ci)=>`<td contenteditable onblur="App.updTable('${block.id}',${r},${ci},this.innerText)">${c}</td>`).join('')}</tr>`;
                    });
                    tcon.innerHTML = html + `</tbody></table>`;
                    card.appendChild(tcon); return card;
                },
                renderGantt(block) {
                    if(!block.events) block.events = [{id:'e1', trackId:'t1', title:'ä»»åŠ¡1', start:new Date().toISOString(), duration:5, color:'#4285f4'}];
                    if(!block.tracks) block.tracks = [{id:'t1', name:'è½¨é“1'}, {id:'t2', name:'è½¨é“2'}];
                    
                    const card = document.createElement('div'); card.className = 'module-card';
                    card.id = `gantt-${block.id}`;
                    card.innerHTML = `<div class="module-toolbar"><div style="display:flex;align-items:center;gap:8px">ğŸ“… <input class="module-title" value="${block.name||'ç”˜ç‰¹å›¾'}" onchange="App.updBlock(this,'${block.id}','name')"></div><div><button class="btn-sm" onclick="App.addGanttEvent('${block.id}')">+ äº‹ä»¶</button><button class="btn-sm" onclick="App.toggleGanttFull('${block.id}')">å…¨å±</button></div></div>`;
                    
                    const con = document.createElement('div'); con.className='gantt-container';
                    const unit = 60; const days = 30; const start = new Date(); start.setDate(start.getDate()-2);
                    
                    // Header
                    const head = document.createElement('div'); head.className='gantt-header';
                    head.innerHTML = `<div class="gantt-corner">è½¨é“</div><div class="gantt-scale"></div>`;
                    const scale = head.querySelector('.gantt-scale');
                    for(let i=0; i<days; i++){
                        const d = Utils.addDays(start, i);
                        const cell = document.createElement('div'); cell.className='gantt-cell'; cell.style.width=unit+'px';
                        cell.innerText = `${d.getMonth()+1}/${d.getDate()}`; scale.appendChild(cell);
                    }
                    con.appendChild(head);

                    // Body
                    const body = document.createElement('div'); body.className='gantt-body';
                    const tracks = document.createElement('div'); tracks.className='gantt-tracks';
                    block.tracks.forEach(t=>{ const d=document.createElement('div'); d.className='gantt-track'; d.innerText=t.name; tracks.appendChild(d); });
                    body.appendChild(tracks);

                    const grid = document.createElement('div'); grid.className='gantt-grid'; grid.style.width=(days*unit)+'px';
                    block.tracks.forEach(()=>{ const r=document.createElement('div'); r.className='gantt-row'; grid.appendChild(r); });
                    
                    // Events
                    block.events.forEach(ev => {
                        const tidx = block.tracks.findIndex(t=>t.id===ev.trackId); if(tidx<0)return;
                        const left = Utils.dateDiff(start, ev.start)*unit;
                        const w = ev.duration*unit;
                        const bar = document.createElement('div'); bar.className='gantt-bar';
                        bar.style.left=left+'px'; bar.style.width=w+'px'; bar.style.top=(tidx*48+10)+'px'; bar.style.backgroundColor=ev.color;
                        bar.innerHTML = `<div class="resize-handle left"></div><span>${ev.title}</span><div class="resize-handle right"></div>`;
                        bar.id = `bar-${block.id}-${ev.id}`;
                        // æ‹–æ‹½
                        bar.onmousedown = (e) => Gantt.startDrag(e, block.id, ev.id, unit, start, left, w);
                        // åŒå‡»ç¼–è¾‘
                        bar.ondblclick = (e) => { e.stopPropagation(); Modal.open(block.id, ev); };
                        grid.appendChild(bar);
                    });
                    
                    body.appendChild(grid);
                    body.onscroll = () => scale.scrollLeft = body.scrollLeft;
                    con.appendChild(body); card.appendChild(con); return card;
                }
            };

            // --- ä¸šåŠ¡é€»è¾‘ ---
            const App = {
                loadPage(id) {
                    State.currentPageId = id; 
                    const p = State.pages.find(x=>x.id===id);
                    document.getElementById('page-title').value = p.title;
                    document.getElementById('breadcrumb').innerText = p.title;
                    Render.sidebar(); Render.editor(p.blocks);
                    this.save();
                },
                addBlock(afterId) {
                    const p = State.pages.find(x=>x.id===State.currentPageId);
                    const nb = {id: Utils.uuid(), type: 'text', content: ''};
                    if(afterId) {
                        const idx = p.blocks.findIndex(b=>b.id===afterId);
                        p.blocks.splice(idx+1, 0, nb);
                    } else { p.blocks.push(nb); }
                    Render.editor(p.blocks); this.save();
                    setTimeout(() => document.querySelector(`[data-id="${nb.id}"] .block-content`)?.focus(), 0);
                },
                appendBlock() { this.addBlock(); }, // åº•éƒ¨ç‚¹å‡»
                toggleTodo(id) {
                    const b = this.getBlock(id); b.checked = !b.checked; Render.editor(State.pages.find(x=>x.id===State.currentPageId).blocks); this.save();
                },
                transform(type) {
                    const b = this.getBlock(State.menuTargetId);
                    b.type = type; b.content = '';
                    Menu.close();
                    App.loadPage(State.currentPageId); // å…¨åˆ·
                },
                createSubPage() {
                    const newId = Utils.uuid();
                    State.pages.push({id: newId, title: 'æœªå‘½åå­é¡µ', parentId: State.currentPageId, blocks: []});
                    const b = this.getBlock(State.menuTargetId);
                    b.type = 'page'; b.pageId = newId;
                    Menu.close(); App.loadPage(State.currentPageId);
                },
                // æ•°æ®æ“ä½œ
                getBlock(id) { return State.pages.find(x=>x.id===State.currentPageId).blocks.find(b=>b.id===id); },
                updBlock(el, id, key) { const b = this.getBlock(id); b[key] = el.value; this.save(); },
                
                // å‚ç›´æ—¶é—´è½´æ“ä½œ
                addVItem(bid) { const b = this.getBlock(bid); if(!b.events) b.events=[]; b.events.push({title:'æ–°èŠ‚ç‚¹', date:'2025-01-01'}); App.loadPage(State.currentPageId); },
                updVItem(bid, idx, key, val) { const b = this.getBlock(bid); b.events[idx][key] = val; this.save(); },
                
                // è¡¨æ ¼æ“ä½œ
                tableRow(bid) { const b = this.getBlock(bid); b.data.push(['','','']); App.loadPage(State.currentPageId); },
                updTable(bid, r, c, val) { const b = this.getBlock(bid); b.data[r][c] = val; this.save(); },

                // ç”˜ç‰¹å›¾æ“ä½œ
                addGanttEvent(bid) { const b=this.getBlock(bid); b.events.push({id:Utils.uuid(), trackId:'t1', title:'æ–°ä»»åŠ¡', start:new Date().toISOString(), duration:3, color:'#4285f4'}); App.loadPage(State.currentPageId); },
                toggleGanttFull(bid) { document.getElementById(`gantt-${bid}`).classList.toggle('gantt-fullscreen'); },
                
                save() { FileIO.updateStatus('å·²ä¿®æ”¹ (Ctrl+S ä¿å­˜)'); },
                deletePage() { 
                    if(confirm('åˆ é™¤?')) { 
                        State.pages = State.pages.filter(p=>p.id!==State.currentPageId);
                        if(State.pages.length) App.loadPage(State.pages[0].id);
                        else FileIO.initNew();
                    }
                },
                createPage() {
                    const id = Utils.uuid();
                    State.pages.push({id, title:'æ–°é¡µé¢', parentId:null, blocks:[]});
                    App.loadPage(id);
                },
                reorderBlock(src, dest) {
                    if(src===dest) return;
                    const blks = State.pages.find(x=>x.id===State.currentPageId).blocks;
                    const sIdx = blks.findIndex(b=>b.id===src); const dIdx = blks.findIndex(b=>b.id===dest);
                    const [moved] = blks.splice(sIdx, 1); blks.splice(dIdx, 0, moved);
                    App.loadPage(State.currentPageId);
                },
                focusEditor(e) { if(e.target.classList.contains('editor-scroller')) App.appendBlock(); }
            };

            // --- èœå•é€»è¾‘ ---
            const Menu = {
                el: document.getElementById('slash-menu'),
                open(e, id, triggerEl) {
                    State.menuTargetId = id;
                    const rect = (triggerEl || document.querySelector(`[data-id="${id}"]`)).getBoundingClientRect();
                    const h = window.innerHeight;
                    this.el.classList.add('show');
                    this.el.style.left = (rect.left + 20) + 'px';
                    if (h - rect.bottom < 320) {
                        this.el.style.top = 'auto'; this.el.style.bottom = (h - rect.top + 5) + 'px';
                    } else {
                        this.el.style.top = (rect.bottom + 5) + 'px'; this.el.style.bottom = 'auto';
                    }
                },
                close() { this.el.classList.remove('show'); }
            };

            // --- ç”˜ç‰¹å›¾äº¤äº’ ---
            const Gantt = {
                startDrag(e, bid, eid, unit, start, left, w) {
                    e.preventDefault(); e.stopPropagation();
                    const cls = e.target.classList;
                    const type = cls.contains('left') ? 'l' : (cls.contains('right') ? 'r' : 'm');
                    State.dragging = { active:true, type, bid, eid, startX: e.clientX, initL: left, initW: w, unit, startDay: start, ev: App.getBlock(bid).events.find(x=>x.id===eid) };
                    document.getElementById(`bar-${bid}-${eid}`).classList.add('dragging');
                },
                move(e) {
                    if(!State.dragging.active) return;
                    const s = State.dragging; const dx = e.clientX - s.startX;
                    const el = document.getElementById(`bar-${s.bid}-${s.eid}`);
                    if(s.type==='m') el.style.left = (s.initL + dx) + 'px';
                    else if(s.type==='r') el.style.width = Math.max(s.unit, s.initW + dx) + 'px';
                    else if(s.type==='l') { 
                        const nw = Math.max(s.unit, s.initW - dx); 
                        el.style.left = (s.initL + (s.initW - nw)) + 'px'; el.style.width = nw + 'px'; 
                    }
                },
                end(e) {
                    if(!State.dragging.active) return;
                    const s = State.dragging;
                    const dx = e.clientX - s.startX; const units = Math.round(dx / s.unit);
                    if(s.type==='m') s.ev.start = Utils.addDays(new Date(s.ev.start), units).toISOString();
                    else if(s.type==='r') s.ev.duration = Math.max(1, s.ev.duration + units);
                    else if(s.type==='l') {
                        const nd = s.ev.duration - units;
                        if(nd>=1) { s.ev.start = Utils.addDays(new Date(s.ev.start), units).toISOString(); s.ev.duration = nd; }
                    }
                    State.dragging.active=false;
                    App.loadPage(State.currentPageId);
                }
            };

            // --- æ¨¡æ€æ¡†é€»è¾‘ ---
            const Modal = {
                el: document.getElementById('event-modal'),
                currentEvent: null,
                open(bid, ev) {
                    this.currentEvent = ev;
                    document.getElementById('ev-title').value = ev.title;
                    document.getElementById('ev-start').value = ev.start.split('T')[0];
                    document.getElementById('ev-duration').value = ev.duration;
                    document.getElementById('ev-color').value = ev.color;
                    this.el.style.display = 'flex';
                },
                save() {
                    const ev = this.currentEvent;
                    ev.title = document.getElementById('ev-title').value;
                    ev.start = new Date(document.getElementById('ev-start').value).toISOString();
                    ev.duration = parseInt(document.getElementById('ev-duration').value);
                    ev.color = document.getElementById('ev-color').value;
                    this.close();
                    App.loadPage(State.currentPageId);
                },
                close() { this.el.style.display = 'none'; }
            };

            // å…¨å±€ç»‘å®š
            window.App = App; window.FileIO = FileIO; window.Menu = Menu; window.Gantt = Gantt; window.Modal = Modal;
            window.onload = () => {
                // é¡µé¢åˆå§‹åŒ–ä¸åŠ è½½ï¼Œç­‰å¾…ç”¨æˆ·é€‰æ‹©æ–‡ä»¶æ“ä½œ
                document.getElementById('page-title').oninput = (e) => { 
                    State.pages.find(x=>x.id===State.currentPageId).title = e.target.value; 
                    App.save(); Render.sidebar(); 
                };
                document.addEventListener('mousemove', Gantt.move);
                document.addEventListener('mouseup', Gantt.end);
                document.addEventListener('click', (e) => {
                    if(!e.target.closest('#slash-menu')) Menu.close();
                    if(e.target.classList.contains('modal-overlay')) Modal.close();
                });
                document.addEventListener('keydown', e => {
                    if(e.ctrlKey && e.key === 's') { e.preventDefault(); FileIO.saveFile(); }
                });
            };
        })();
    </script>
</body>
</html>